{% extends 'patient_dashboard.html' %}
{% block content_dash %}
<h3 class="text-dark">Chat with {{ recipient.get_full_name }}</h3>
<div class="container bg-dark bordered border">
    <div class="chat-box container bg-white bordered border" id="chat-box">
        {% for message in messages %}
            <div class="message {% if message.sender == request.user %}sent{% else %}received{% endif %}">
                <p><strong>
                    {% if message.sender == request.user %}
                        Me
                    {% else %}
                        {{ message.sender.get_full_name }}
                    {% endif %}
                </strong></p>
                <p>{{ message.message_text }}</p>
                <i class="timestamp">{{ message.timestamp|date:"Y-m-d H:i" }}</i>
            </div>
        {% endfor %}
    </div>
</div>
<hr>

<!-- Pagination Controls -->
<div class="pagination-controls">
    {% if messages.has_previous %}
        <a href="?page={{ messages.previous_page_number }}" class="btn btn-secondary">Older Messages</a>
    {% endif %}
    {% if messages.has_next %}
        <a href="?page={{ messages.next_page_number }}" class="btn btn-secondary">Newer Messages</a>
    {% endif %}
</div>

<!-- Message Form -->
<form id="chat-form">
    {% csrf_token %}
    <textarea id="message-input" rows="2" placeholder="Type your message..." class="form-control"></textarea>
    <button type="submit" class="btn btn-primary mt-2">Send</button>
</form>

<script>
    const roomName = "{{ room_name }}";
    const userId = "{{ request.user.id }}";
    const recipientId = "{{ recipient.id }}";

    const chatSocket = new WebSocket('ws://' + window.location.host + '/ws/chat/' + roomName + '/');

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);

        const messageElement = document.createElement('div');
        messageElement.className = 'message ' + (data.sender == userId ? 'sent' : 'received');
        messageElement.innerHTML = `
            <p><strong>${data.sender == userId ? 'Me' : '{{ recipient.get_full_name }}'}</strong></p>
            <p>${data.message}</p>
            <i class="timestamp">${new Date().toLocaleString()}</i>
        `;
        document.getElementById('chat-box').appendChild(messageElement);
    };

    document.getElementById('chat-form').onsubmit = function(e) {
        e.preventDefault();
        const messageInput = document.getElementById('message-input');
        const message = messageInput.value;
        chatSocket.send(JSON.stringify({
            'message': message,
            'sender': userId,
            'recipient': recipientId,
        }));
        messageInput.value = '';
    };
</script>
{% endblock %}
